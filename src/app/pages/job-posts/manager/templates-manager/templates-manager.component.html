<!-- Template 1: Classic (Redesigned) -->
<div *ngIf="templateId === '1' && jobAppData">
  <div class="max-w-4xl mx-auto p-3 sm:p-6 bg-white rounded-lg shadow-sm" [ngStyle]="{
      '--primary-color': jobAppData?.colorScheme?.primary,
      '--secondary-color': jobAppData?.colorScheme?.secondary,
      '--accent-color': jobAppData?.colorScheme?.accent || jobAppData?.colorScheme?.primary
    }">
    <!-- Company Header -->
    <div class="mb-8" *ngIf="formOnly === false">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img [src]="jobAppData.company.logoUrl" alt="Company Logo" class="h-10 sm:h-12" />
          <h1 *ngIf="jobAppData.company.logoUrl.length == 0"
            class="text-xl sm:text-2xl font-bold text-[var(--primary-color)]">
            {{ jobAppData.company.name }}
          </h1>
        </div>

        <!-- Mobile Menu Button -->
        <button (click)="toggleMenu()" class="p-2 text-gray-600 sm:hidden hover:text-gray-900 focus:outline-none"
          aria-label="Toggle menu">
          <svg *ngIf="!isMenuOpen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <svg *ngIf="isMenuOpen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex space-x-4">
          <a *ngFor="
              let link of formattingService.processLinks(
                jobAppData.company!.navLinks
              )
            " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
            [attr.target]="link.type === 'url' ? '_blank' : null"
            class="text-sm text-[var(--secondary-color)] hover:text-[var(--primary-color)] transition-colors">
            {{ link.text }}
          </a>
        </nav>
      </div>
      <!-- Mobile Navigation -->
      <div *ngIf="isMenuOpen" class="sm:hidden mt-4">
        <div class="px-2 pt-2 pb-3 space-y-1 bg-gray-50 rounded-lg">
          <a *ngFor="
              let link of formattingService.processLinks(
                jobAppData.company.navLinks
              )
            " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
            [attr.target]="link.type === 'url' ? '_blank' : null"
            class="block px-3 py-2 text-base text-[var(--secondary-color)] hover:bg-gray-100 rounded-md">
            {{ link.text }}
          </a>
        </div>
      </div>
    </div>

    <!-- Job Details -->
    <div class="mb-8" *ngIf="formOnly === false">
      <h2 class="text-xl sm:text-2xl font-semibold text-[var(--primary-color)]">
        {{ jobAppData.job.title }}
      </h2>
      <p class="mt-2 text-gray-700" [innerHTML]="
          formattingService.parseMarkdown(jobAppData.job.description)
        "></p>
    </div>

    <!-- Deadline Check -->
    <div *ngIf="deadlinePassed" class="text-center py-4 sm:py-6 bg-red-50 rounded-lg border border-red-200">
      <h3 class="text-lg sm:text-xl font-bold text-red-600">Deadline Ended</h3>
      <p class="text-gray-600">The application deadline has passed.</p>
    </div>

    <!-- Application Form -->
    <div *ngIf="!deadlinePassed" class="mb-8">
      <h3 class="text-xl sm:text-2xl font-semibold text-[var(--primary-color)]">
        {{ jobAppData.applySection.title }}
      </h3>
      <p class="mt-2 text-gray-700">
        {{ jobAppData.applySection.instructions }}
      </p>

      <!-- Section Tabs -->
      <div *ngIf="jobAppData.sections.length > 1" class="mb-6 mt-5 bg-gray-100 p-2 rounded-lg">
        <div class="flex flex-wrap gap-2">
          <button *ngFor="let section of jobAppData.sections" (click)="setCurrentSection(section)" [class]="
              section == activeSection
                ? 'px-4 py-2 bg-[var(--primary-color)] text-white rounded-md text-sm font-medium transition-all duration-200'
                : 'px-4 py-2 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-200 transition-all duration-200'
            ">
            {{ section }}
          </button>
        </div>
      </div>

      <!-- Form Fields -->
      <form *ngIf="form" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Form Fields -->
        <div *ngFor="let field of jobAppData.formData.fields" [hidden]="field.section !== activeSection" class="mb-4">
          <label [for]="field.key" class="block text-sm font-medium text-gray-700">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-500">*</span>
          </label>

          <p *ngIf="field.instructions" class="mt-1 text-sm text-gray-500"
            [innerHTML]="formattingService.parseMarkdown(field.instructions)"></p>

          <!-- Text Input -->
          <input *ngIf="
              ['text', 'email', 'tel', 'number', 'date'].includes(field.type || 'text')
            " [type]="field.type" [id]="field.key" [minlength]="field.min_length || null"
            [maxlength]="field.max_length || null" [formControlName]="field.key"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" />

          <!-- Textarea -->
          <textarea *ngIf="field.type === 'textarea'" [id]="field.key" [formControlName]="field.key"
            [minlength]="field.min_length || null" [maxlength]="field.max_length || null" rows="4"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]"></textarea>

          <!-- Select -->
          <select *ngIf="field.type === 'select'" [id]="field.key" [formControlName]="field.key"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
            <option value="">Select an option</option>
            <option *ngFor="let option of field.options" [value]="option">
              {{ option }}
            </option>
          </select>

          <!-- File Input -->
          <input *ngIf="field.type === 'file'" type="file" [id]="field.key" [formControlName]="field.key"
            [accept]="field.acceptedTypes" (change)="onFileChange($event, field.key)"
            class="mt-1 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)] file:text-white hover:file:bg-[var(--secondary-color)]" />

          <p *ngIf="field.type === 'file'" class="text-xs text-gray-500">
            Accepted formats: {{ field.acceptedTypes }}
            <span *ngIf="field.max_length">, Max size: {{ field.max_length }}MB</span>
          </p>
        </div>

        <!-- Navigation Buttons for Multi-Section Forms -->
        <div class="flex justify-between mt-8">
          <button *ngIf="jobAppData.sections.length > 1" type="button" (click)="goToPreviousSection()"
            [disabled]="jobAppData.sections.indexOf(activeSection) === 0"
            class="px-6 py-2 border border-[var(--primary-color)] text-[var(--primary-color)] rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[var(--primary-color)] hover:text-white transition-colors">
            Previous
          </button>

          <button type="button" (click)="goToNextSection()"
            [disabled]="jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
            class="px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[var(--secondary-color)] transition-colors">
            Next
          </button>
        </div>

        <!-- Declaration Checkbox -->
        <div
          *ngIf="jobAppData.applySection.declaration && jobAppData.sections.indexOf(activeSection) >= jobAppData.sections.length - 1"
          class="mt-4">
          <label class="flex items-start space-x-2">
            <input key="agreeToDeclaration" type="checkbox" formControlName="agreeToDeclaration" id="acceptDeclaration"
              class="mt-1 h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]" />
            <span class="text-sm text-gray-700">{{
              jobAppData.applySection.declaration
              }}</span>
          </label>
        </div>

        <!-- Submit Button (Only show on last section) -->
        <div *ngIf="jobAppData.sections.indexOf(activeSection) >= jobAppData.sections.length - 1" class="mt-6">
          <button type="submit" [disabled]="form.invalid || isSubmitting"
            class="w-full px-6 py-3 text-white bg-[var(--primary-color)] hover:bg-[var(--secondary-color)] rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 shadow-md">
            <span *ngIf="!isSubmitting">Submit Application - Test</span>
            <span *ngIf="isSubmitting" class="flex items-center justify-center">
              <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              Submitting...
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="mt-8 bg-gray-50 rounded-md p-8 text-center border-t pt-6">
      <p class="text-sm text-gray-600">
        {{ jobAppData.footer.copyrightText }}
      </p>
      <nav class="mt-2 flex flex-wrap justify-center gap-2 sm:gap-4">
        <a *ngFor="
            let link of formattingService.processLinks(jobAppData.footer.links)
          " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
          [attr.target]="link.type === 'url' ? '_blank' : null"
          class="text-sm text-[var(--secondary-color)] hover:text-[var(--primary-color)] hover:underline transition-colors">
          {{ link.text }}
        </a>
      </nav>
    </div>
  </div>
</div>
<!-- End Template 1 -->

<!-- Template 2: Modern Card (New Design) -->
<div *ngIf="templateId === '2' && jobAppData">
  <div class="max-w-4xl mx-auto p-3 sm:p-6" [ngStyle]="{
      '--primary-color': jobAppData?.colorScheme?.primary,
      '--secondary-color': jobAppData?.colorScheme?.secondary,
      '--accent-color': jobAppData?.colorScheme?.accent || jobAppData?.colorScheme?.primary
    }">
    <!-- Header Card -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="bg-gradient-to-r from-[var(--primary-color)] to-[var(--secondary-color)] p-6 text-white">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <img [src]="jobAppData.company.logoUrl" alt="Company Logo" class="h-12 sm:h-16 bg-white p-2 rounded-lg" />
            <div>
              <h1 class="text-2xl sm:text-3xl font-bold">{{ jobAppData.company.name }}</h1>
              <p class="text-white/80 text-sm mt-1">{{ jobAppData.job.title }}</p>
            </div>
          </div>

          <!-- Desktop Navigation -->
          <nav class="hidden sm:flex space-x-4">
            <a *ngFor="
                let link of formattingService.processLinks(
                  jobAppData.company!.navLinks
                )
              " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
              [attr.target]="link.type === 'url' ? '_blank' : null"
              class="text-sm text-white/90 hover:text-white transition-colors">
              {{ link.text }}
            </a>
          </nav>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div class="p-4 border-b" *ngIf="isMenuOpen">
        <div class="flex flex-col space-y-2">
          <a *ngFor="
              let link of formattingService.processLinks(
                jobAppData.company.navLinks
              )
            " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
            [attr.target]="link.type === 'url' ? '_blank' : null"
            class="px-3 py-2 text-base text-[var(--secondary-color)] hover:bg-gray-100 rounded-md">
            {{ link.text }}
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Job Details Sidebar -->
      <div class="lg:col-span-1" *ngIf="formOnly === false">
        <div class="bg-white rounded-xl shadow-md p-6 sticky top-6">
          <h3 class="text-lg font-semibold text-[var(--primary-color)] mb-4">Job Details</h3>
          <div class="space-y-4">
            <div class="text-gray-700 prose prose-sm max-w-none" [innerHTML]="
                formattingService.parseMarkdown(jobAppData.job.description)
              "></div>
          </div>
        </div>
      </div>

      <!-- Application Form -->
      <div class="lg:col-span-2" *ngIf="!deadlinePassed">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-xl font-semibold text-[var(--primary-color)] mb-2">
            {{ jobAppData.applySection.title }}
          </h3>
          <p class="text-gray-600 mb-6">
            {{ jobAppData.applySection.instructions }}
          </p>

          <!-- Section Progress -->
          <div *ngIf="jobAppData.sections.length > 1" class="mb-6">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Progress</span>
              <span class="text-sm text-gray-500">
                {{ jobAppData.sections.indexOf(activeSection) + 1 }} of {{ jobAppData.sections.length }}
              </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-[var(--primary-color)] h-2 rounded-full transition-all duration-300"
                [style.width]="((jobAppData.sections.indexOf(activeSection) + 1) / jobAppData.sections.length) * 100 + '%'">
              </div>
            </div>
          </div>

          <!-- Section Tabs -->
          <div *ngIf="jobAppData.sections.length > 1" class="mb-6 flex overflow-x-auto pb-2 space-x-2">
            <button *ngFor="let section of jobAppData.sections" (click)="setCurrentSection(section)" [class]="
                section == activeSection
                  ? 'px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg text-sm font-medium transition-all duration-200 flex-shrink-0'
                  : 'px-4 py-2 text-gray-600 bg-gray-100 rounded-lg text-sm font-medium hover:bg-gray-200 transition-all duration-200 flex-shrink-0'
              ">
              {{ section }}
            </button>
          </div>

          <!-- Form Fields -->
          <form *ngIf="form" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
            <!-- Form Fields -->
            <div *ngFor="let field of jobAppData.formData.fields" [hidden]="field.section !== activeSection"
              class="mb-4">
              <label [for]="field.key" class="block text-sm font-medium text-gray-700">
                {{ field.label }}
                <span *ngIf="field.required" class="text-red-500">*</span>
              </label>

              <p *ngIf="field.instructions" class="mt-1 text-sm text-gray-500"
                [innerHTML]="formattingService.parseMarkdown(field.instructions)"></p>

              <!-- Text Input -->
              <input *ngIf="
                  ['text', 'email', 'tel', 'number', 'date'].includes(field.type || 'text')
                " [type]="field.type" [id]="field.key" [minlength]="field.min_length || null"
                [maxlength]="field.max_length || null" [formControlName]="field.key"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" />

              <!-- Textarea -->
              <textarea *ngIf="field.type === 'textarea'" [id]="field.key" [formControlName]="field.key"
                [minlength]="field.min_length || null" [maxlength]="field.max_length || null" rows="4"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]"></textarea>

              <!-- Select -->
              <select *ngIf="field.type === 'select'" [id]="field.key" [formControlName]="field.key"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                <option value="">Select an option</option>
                <option *ngFor="let option of field.options" [value]="option">
                  {{ option }}
                </option>
              </select>

              <!-- File Input -->
              <input *ngIf="field.type === 'file'" type="file" [id]="field.key" [formControlName]="field.key"
                [accept]="field.acceptedTypes" (change)="onFileChange($event, field.key)"
                class="mt-1 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)] file:text-white hover:file:bg-[var(--secondary-color)]" />

              <p *ngIf="field.type === 'file'" class="text-xs text-gray-500">
                Accepted formats: {{ field.acceptedTypes }}
                <span *ngIf="field.max_length">, Max size: {{ field.max_length }}MB</span>
              </p>
            </div>

            <!-- Navigation Buttons -->
            <div *ngIf="jobAppData.sections.length > 1" class="flex justify-between mt-8">
              <button type="button" (click)="goToPreviousSection()"
                [disabled]="jobAppData.sections.indexOf(activeSection) === 0"
                class="px-6 py-3 border border-[var(--primary-color)] text-[var(--primary-color)] rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[var(--primary-color)] hover:text-white transition-colors flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Previous
              </button>

              <button *ngIf="jobAppData.sections.indexOf(activeSection) < jobAppData.sections.length - 1" type="button"
                (click)="goToNextSection()"
                class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[var(--secondary-color)] transition-colors flex items-center">
                Next
                <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>

              <!-- Submit Button (Only show on last section) -->
              <button *ngIf="jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
                type="submit" [disabled]="form.invalid || isSubmitting"
                class="px-6 py-3 text-white bg-[var(--primary-color)] hover:bg-[var(--secondary-color)] rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 shadow-md">
                <span *ngIf="!isSubmitting">Submit Application</span>
                <span *ngIf="isSubmitting" class="flex items-center justify-center">
                  <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                      fill="none" />
                    <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                  Submitting...
                </span>
              </button>
            </div>

            <!-- Declaration Checkbox -->
            <div
              *ngIf="jobAppData.applySection.declaration && jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
              class="mt-4">
              <label class="flex items-start space-x-2">
                <input type="checkbox" key="agreeToDeclaration" formControlName="agreeToDeclaration" id="acceptDeclaration"
                  class="mt-1 h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]" />
                <span class="text-sm text-gray-700">{{
                  jobAppData.applySection.declaration
                  }}</span>
              </label>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 bg-white rounded-xl shadow-md p-6 text-center">
      <p class="text-sm text-gray-600">
        {{ jobAppData.footer.copyrightText }}
      </p>
      <nav class="mt-2 flex flex-wrap justify-center gap-2 sm:gap-4">
        <a *ngFor="
            let link of formattingService.processLinks(jobAppData.footer.links)
          " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
          [attr.target]="link.type === 'url' ? '_blank' : null"
          class="text-sm text-[var(--secondary-color)] hover:text-[var(--primary-color)] hover:underline transition-colors">
          {{ link.text }}
        </a>
      </nav>
    </div>
  </div>
</div>
<!-- End Template 2 -->

<!-- Template 3: Minimalist (New Design) -->
<div *ngIf="templateId === '3' && jobAppData">
  <div class="max-w-3xl mx-auto p-3 sm:p-6" [ngStyle]="{
      '--primary-color': jobAppData?.colorScheme?.primary,
      '--secondary-color': jobAppData?.colorScheme?.secondary,
      '--accent-color': jobAppData?.colorScheme?.accent || jobAppData?.colorScheme?.primary
    }">
    <!-- Simple Header -->
    <div class="text-start mb-8" *ngIf="formOnly === false">
      <div class="flex justify-start mb-4">
        <img *ngIf="jobAppData.company.logoUrl" [src]="jobAppData.company.logoUrl" alt="Company Logo"
          class="h-12 sm:h-16" />
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold text-[var(--primary-color)]">
        {{ jobAppData.company.name }}
      </h1>
      <h2 class="text-xl sm:text-2xl text-gray-700 mt-2">
        {{ jobAppData.job.title }}
      </h2>
    </div>

    <!-- Deadline Check -->
    <div *ngIf="deadlinePassed" class="text-center py-4 sm:py-6 bg-red-50 rounded-lg border border-red-200 mb-6">
      <h3 class="text-lg sm:text-xl font-bold text-red-600">Deadline Ended</h3>
      <p class="text-gray-600">The application deadline has passed.</p>
    </div>

    <!-- Application Form -->
    <div *ngIf="!deadlinePassed" class="bg-white rounded-lg border border-gray-200 p-6">
      <h3 class="text-xl font-semibold text-[var(--primary-color)] mb-2">
        {{ jobAppData.applySection.title }}
      </h3>
      <p class="text-gray-600 mb-6">
        {{ jobAppData.applySection.instructions }}
      </p>

      <!-- Section Indicator -->
      <div *ngIf="jobAppData.sections.length > 1" class="mb-6">
        <div class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-700">Section:</span>
          <span class="text-sm font-semibold text-[var(--primary-color)]">{{ activeSection }}</span>
          <span class="text-sm text-gray-500 ml-auto">
            {{ jobAppData.sections.indexOf(activeSection) + 1 }} of {{ jobAppData.sections.length }}
          </span>
        </div>
      </div>

      <!-- Form Fields -->
      <form *ngIf="form" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Form Fields -->
        <div *ngFor="let field of jobAppData.formData.fields" [hidden]="field.section !== activeSection" class="mb-4">
          <label [for]="field.key" class="block text-sm font-medium text-gray-700">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-500">*</span>
          </label>

          <p *ngIf="field.instructions" class="mt-1 text-sm text-gray-500"
            [innerHTML]="formattingService.parseMarkdown(field.instructions)"></p>

          <!-- Text Input -->
          <input *ngIf="
              ['text', 'email', 'tel', 'number', 'date'].includes(field.type || 'text')
            " [type]="field.type" [id]="field.key" [minlength]="field.min_length || null"
            [maxlength]="field.max_length || null" [formControlName]="field.key"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-[var(--primary-color)]" />

          <!-- Textarea -->
          <textarea *ngIf="field.type === 'textarea'" [id]="field.key" [formControlName]="field.key"
            [minlength]="field.min_length || null" [maxlength]="field.max_length || null" rows="4"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-[var(--primary-color)]"></textarea>

          <!-- Select -->
          <select *ngIf="field.type === 'select'" [id]="field.key" [formControlName]="field.key"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-[var(--primary-color)]">
            <option value="">Select an option</option>
            <option *ngFor="let option of field.options" [value]="option">
              {{ option }}
            </option>
          </select>

          <!-- File Input -->
          <input *ngIf="field.type === 'file'" type="file" [id]="field.key" [formControlName]="field.key"
            [accept]="field.acceptedTypes" (change)="onFileChange($event, field.key)"
            class="mt-1 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)] file:text-white hover:file:bg-[var(--secondary-color)]" />

          <p *ngIf="field.type === 'file'" class="text-xs text-gray-500">
            Accepted formats: {{ field.acceptedTypes }}
            <span *ngIf="field.max_length">, Max size: {{ field.max_length }}MB</span>
          </p>
        </div>

        <!-- Navigation Buttons -->
        <div *ngIf="jobAppData.sections.length > 1" class="flex justify-between mt-8 pt-6 border-t border-gray-200">
          <button type="button" (click)="goToPreviousSection()"
            [disabled]="jobAppData.sections.indexOf(activeSection) === 0"
            class="px-4 py-2 text-[var(--primary-color)] rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors">
            ← Previous
          </button>

          <button *ngIf="jobAppData.sections.indexOf(activeSection) < jobAppData.sections.length - 1" type="button"
            (click)="goToNextSection()"
            class="px-4 py-2 text-[var(--primary-color)] rounded-md hover:bg-gray-100 transition-colors">
            Next →
          </button>

          <!-- Submit Button (Only show on last section) -->
          <button *ngIf="jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1" type="submit"
            [disabled]="form.invalid || isSubmitting"
            class="px-6 py-2 text-white bg-[var(--primary-color)] rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-[var(--secondary-color)] transition-colors">
            <span *ngIf="!isSubmitting">Submit Application</span>
            <span *ngIf="isSubmitting" class="flex items-center justify-center">
              <svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              Submitting...
            </span>
          </button>
        </div>

        <!-- Declaration Checkbox -->
        <div
          *ngIf="jobAppData.applySection.declaration && jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
          class="mt-4">
          <label class="flex items-start space-x-2">
            <input type="checkbox" key="agreeToDeclaration" formControlName="agreeToDeclaration" id="acceptDeclaration"
              class="mt-1 h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]" />
            <span class="text-sm text-gray-700">{{
              jobAppData.applySection.declaration
              }}</span>
          </label>
        </div>
      </form>
    </div>

    <!-- Simple Footer -->
    <div class="mt-8 text-center">
      <p class="text-sm text-gray-600">
        {{ jobAppData.footer.copyrightText }}
      </p>
      <nav class="mt-2 flex flex-wrap justify-center gap-2 sm:gap-4">
        <a *ngFor="
            let link of formattingService.processLinks(jobAppData.footer.links)
          " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
          [attr.target]="link.type === 'url' ? '_blank' : null"
          class="text-sm text-[var(--secondary-color)] hover:text-[var(--primary-color)] transition-colors">
          {{ link.text }}
        </a>
      </nav>
    </div>
  </div>
</div>
<!-- End Template 3 -->

<!-- Template 4: Sidebar Layout (New Design) -->
<div *ngIf="templateId === '4' && jobAppData">
  <div class="min-h-screen bg-gray-50" [ngStyle]="{
      '--primary-color': jobAppData?.colorScheme?.primary,
      '--secondary-color': jobAppData?.colorScheme?.secondary,
      '--accent-color': jobAppData?.colorScheme?.accent || jobAppData.colorScheme?.primary
    }">
    <!-- Header -->
    <header class="bg-white shadow-sm" *ngIf="formOnly === false">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <img [src]="jobAppData.company.logoUrl" alt="Company Logo" class="h-8 sm:h-10 mr-4" />
            <h1 class="text-xl font-bold text-[var(--primary-color)]">
              {{ jobAppData.company.name }}
            </h1>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a *ngFor="
                let link of formattingService.processLinks(
                  jobAppData.company!.navLinks
                )
              " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
              [attr.target]="link.type === 'url' ? '_blank' : null"
              class="text-sm font-medium text-gray-500 hover:text-[var(--primary-color)] transition-colors">
              {{ link.text }}
            </a>
          </nav>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-6 sm:px-0">
        <div class="flex flex-col lg:flex-row gap-8">
          <!-- Sidebar -->
          <div class="lg:w-1/3" *ngIf="formOnly === false">
            <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
              <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-2">
                {{ jobAppData.job.title }}
              </h2>
              <div class="text-gray-600 prose prose-sm max-w-none mt-4" [innerHTML]="
                  formattingService.parseMarkdown(jobAppData.job.description)
                "></div>

              <!-- Progress for multi-section forms -->
              <div *ngIf="jobAppData.sections.length > 1" class="mt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-3">Application Progress</h3>
                <div class="space-y-3">
                  <div *ngFor="let section of jobAppData.sections; let i = index" class="flex items-center">
                    <div [class]="
                      jobAppData.sections.indexOf(activeSection) >= i 
                        ? 'w-3 h-3 rounded-full bg-[var(--primary-color)] mr-3'
                        : 'w-3 h-3 rounded-full bg-gray-300 mr-3'
                    "></div>
                    <span [class]="
                      jobAppData.sections.indexOf(activeSection) >= i
                        ? 'text-sm font-medium text-[var(--primary-color)]'
                        : 'text-sm text-gray-500'
                    ">{{ section }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="lg:w-2/3">
            <!-- Deadline Check -->
            <div *ngIf="deadlinePassed" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
              <h3 class="text-lg font-bold text-red-600">Deadline Ended</h3>
              <p class="text-gray-600">The application deadline has passed.</p>
            </div>

            <!-- Application Form -->
            <div *ngIf="!deadlinePassed" class="bg-white rounded-lg shadow-sm p-6">
              <h3 class="text-2xl font-semibold text-[var(--primary-color)] mb-2">
                {{ jobAppData.applySection.title }}
              </h3>
              <p class="text-gray-600 mb-6">
                {{ jobAppData.applySection.instructions }}
              </p>

              <!-- Form Fields -->
              <form *ngIf="form" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
                <!-- Form Fields -->
                <div *ngFor="let field of jobAppData.formData.fields" [hidden]="field.section !== activeSection"
                  class="mb-4">
                  <label [for]="field.key" class="block text-sm font-medium text-gray-700">
                    {{ field.label }}
                    <span *ngIf="field.required" class="text-red-500">*</span>
                  </label>

                  <p *ngIf="field.instructions" class="mt-1 text-sm text-gray-500"
                    [innerHTML]="formattingService.parseMarkdown(field.instructions)"></p>

                  <!-- Text Input -->
                  <input *ngIf="
                      ['text', 'email', 'tel', 'number', 'date'].includes(field.type || 'text')
                    " [type]="field.type" [id]="field.key" [minlength]="field.min_length || null"
                    [maxlength]="field.max_length || null" [formControlName]="field.key"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]" />

                  <!-- Textarea -->
                  <textarea *ngIf="field.type === 'textarea'" [id]="field.key" [formControlName]="field.key"
                    [minlength]="field.min_length || null" [maxlength]="field.max_length || null" rows="4"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]"></textarea>

                  <!-- Select -->
                  <select *ngIf="field.type === 'select'" [id]="field.key" [formControlName]="field.key"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                    <option value="">Select an option</option>
                    <option *ngFor="let option of field.options" [value]="option">
                      {{ option }}
                    </option>
                  </select>

                  <!-- File Input -->
                  <input *ngIf="field.type === 'file'" type="file" [id]="field.key" [formControlName]="field.key"
                    [accept]="field.acceptedTypes" (change)="onFileChange($event, field.key)"
                    class="mt-1 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)] file:text-white hover:file:bg-[var(--secondary-color)]" />

                  <p *ngIf="field.type === 'file'" class="text-xs text-gray-500">
                    Accepted formats: {{ field.acceptedTypes }}
                    <span *ngIf="field.max_length">, Max size: {{ field.max_length }}MB</span>
                  </p>
                </div>

                <!-- Navigation Buttons -->
                <div *ngIf="jobAppData.sections.length > 1"
                  class="flex justify-between mt-8 pt-6 border-t border-gray-200">
                  <button type="button" (click)="goToPreviousSection()"
                    [disabled]="jobAppData.sections.indexOf(activeSection) === 0"
                    class="px-6 py-2 border border-[var(--primary-color)] text-[var(--primary-color)] rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[var(--primary-color)] hover:text-white transition-colors">
                    Previous
                  </button>

                  <button *ngIf="jobAppData.sections.indexOf(activeSection) < jobAppData.sections.length - 1"
                    type="button" (click)="goToNextSection()"
                    class="px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[var(--secondary-color)] transition-colors">
                    Next
                  </button>

                  <!-- Submit Button (Only show on last section) -->
                  <button *ngIf="jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
                    type="submit" [disabled]="form.invalid || isSubmitting"
                    class="px-6 py-2 text-white bg-[var(--primary-color)] rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-[var(--secondary-color)] transition-colors">
                    <span *ngIf="!isSubmitting">Submit Application</span>
                    <span *ngIf="isSubmitting" class="flex items-center justify-center">
                      <svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                          fill="none" />
                        <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                      </svg>
                      Submitting...
                    </span>
                  </button>
                </div>

                <!-- Declaration Checkbox -->
                <div
                  *ngIf="jobAppData.applySection.declaration && jobAppData.sections.indexOf(activeSection) === jobAppData.sections.length - 1"
                  class="mt-4">
                  <label class="flex items-start space-x-2">
                    <input type="checkbox" key="agreeToDeclaration" formControlName="agreeToDeclaration" id="acceptDeclaration"
                      class="mt-1 h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]" />
                    <span class="text-sm text-gray-700">{{
                      jobAppData.applySection.declaration
                      }}</span>
                  </label>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
      <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <p class="text-sm text-gray-600">
            {{ jobAppData.footer.copyrightText }}
          </p>
          <nav class="mt-2 flex flex-wrap justify-center gap-4">
            <a *ngFor="
                let link of formattingService.processLinks(jobAppData.footer.links)
              " [href]="link.formattedUrl" [attr.rel]="link.type === 'url' ? 'noopener noreferrer' : null"
              [attr.target]="link.type === 'url' ? '_blank' : null"
              class="text-sm text-[var(--secondary-color)] hover:text-[var(--primary-color)] transition-colors">
              {{ link.text }}
            </a>
          </nav>
        </div>
      </div>
    </footer>
  </div>
</div>
<!-- End Template 4 -->

<!-- Keep your existing popup components as they are -->
<!-- Submission Popover -->
<div *ngIf="showSubmissionMessage" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fadeIn">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all animate-scaleIn">
    <!-- Top Pattern -->
    <div
      class="absolute inset-x-0 top-0 h-2 bg-gradient-to-r from-[var(--primary-color)] to-[var(--secondary-color)] rounded-t-xl">
    </div>

    <div class="px-6 py-8">
      <!-- Success Icon -->
      <div class="mb-6">
        <div class="mx-auto w-16 h-16 rounded-full bg-[var(--primary-color)]/10 flex items-center justify-center">
          <svg class="w-10 h-10 text-[var(--primary-color)]" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
        </div>
      </div>

      <!-- Content -->
      <div class="text-center space-y-3">
        <h3 class="text-2xl font-bold text-[var(--primary-color)]">
          {{ jobAppData?.submissionMessage?.title }}
        </h3>
        <p class="text-gray-600">
          {{ jobAppData?.submissionMessage?.message }}
        </p>
      </div>

      <!-- Actions -->
      <div class="mt-8 flex flex-col gap-3">
      <a href="{jobAppData?.submissionMessage?.actionLink}">
          <button class="w-full px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg font-medium
                 hover:bg-[var(--secondary-color)] transform hover:scale-[1.02] 
                 transition-all duration-200 shadow-lg shadow-[var(--primary-color)]/20">
          {{ jobAppData?.submissionMessage?.actionText }}
        </button>
      </a>
      </div>
    </div>
  </div>
</div>

<!-- Error Alert -->
<div *ngIf="showError"
  class="fixed bottom-4 right-4 left-4 sm:left-auto bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg shadow-lg">
  <p>An error occurred while submitting your application. Please try again.</p>
</div>

<!-- Error Popup -->
<div *ngIf="showPopup" class="fixed top-4 right-4 z-50 animate-slide-in" [ngClass]="{
    'animate-shake': popupType === 'error'
  }">
  <div class="rounded-lg shadow-lg p-4 min-w-[320px]" [ngClass]="{
      'bg-red-50 border-l-4 border-red-500': popupType === 'error',
      'bg-green-50 border-l-4 border-green-500': popupType === 'success',
      'bg-blue-50 border-l-4 border-blue-500': popupType === 'info',
      'bg-yellow-50 border-l-4 border-yellow-500': popupType === 'warning'
    }">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <span class="flex-shrink-0" [ngClass]="{
            'text-red-500': popupType === 'error',
            'text-green-500': popupType === 'success',
            'text-blue-500': popupType === 'info',
            'text-yellow-500': popupType === 'warning'
          }">
          <i class="fas" [ngClass]="{
              'fa-exclamation-circle': popupType === 'error',
              'fa-check-circle': popupType === 'success',
              'fa-info-circle': popupType === 'info',
              'fa-exclamation-triangle': popupType === 'warning'
            }"></i>
        </span>
        <p class="ml-3 text-sm font-medium" [ngClass]="{
            'text-red-800': popupType === 'error',
            'text-green-800': popupType === 'success',
            'text-blue-800': popupType === 'info',
            'text-yellow-800': popupType === 'warning'
          }">
          {{ popupMessage }}
        </p>
      </div>
    </div>
  </div>
</div>
<!-- End Error Popup-->